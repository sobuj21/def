<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>Usage Statistics - d.aurtho.com</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Ctext%20x='50%25'%20y='50%25'%20dominant-baseline='central'%20text-anchor='middle'%20font-size='85'%20font-family='sans-serif'%20font-weight='bold'%20fill='%2360a5fa'%3ES%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .stat-circle {
            width: 150px; height: 150px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-circle:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .stat-number { font-size: 2.5rem; font-weight: 700; }
        .stat-label { font-size: 0.875rem; margin-top: 0.25rem; }
        .loader { border: 4px solid #4A5568; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-900 min-h-screen p-4 md:p-8 text-slate-200">
    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-100">Usage Statistics</h1>
            <p class="text-slate-400 mt-1">Photo & API Call Metrics</p>
            <a href="/" class="text-sm text-blue-400 hover:underline mt-2 inline-block">&larr; Back to Data Extractor</a>
        </header>

        <main>
            <!-- Search Controls -->
            <section class="bg-slate-800 p-4 rounded-lg shadow-lg mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                <div>
                    <label for="monthSelect" class="block text-sm font-medium text-slate-300 mb-1">Month</label>
                    <select id="monthSelect" class="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div>
                    <label for="yearSelect" class="block text-sm font-medium text-slate-300 mb-1">Year</label>
                    <select id="yearSelect" class="bg-slate-700 border border-slate-600 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <button id="searchButton" class="self-end sm:self-center mt-2 sm:mt-0 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:ring-offset-slate-800 font-semibold">
                    Search
                </button>
            </section>
            
            <div id="loader" class="flex justify-center items-center py-20 hidden"><div class="loader"></div></div>
            <div id="errorMessage" class="hidden text-center bg-red-900/50 border border-red-700 text-red-300 p-4 rounded-md"></div>

            <!-- Dashboard Layout -->
            <section id="statsContainer" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 mb-10 justify-items-center">
                    <div class="stat-circle bg-slate-800 border-2 border-cyan-500">
                        <span id="todayPhotos" class="stat-number text-cyan-400">0</span>
                        <span class="stat-label text-slate-400">Today's Photos</span>
                    </div>
                    <div class="stat-circle bg-slate-800 border-2 border-green-500">
                        <span id="monthPhotos" class="stat-number text-green-400">0</span>
                        <span class="stat-label text-slate-400">This Month's Photos</span>
                    </div>
                    <div class="stat-circle bg-slate-800 border-2 border-purple-500">
                        <span id="monthGeminiCalls" class="stat-number text-purple-400">0</span>
                        <span class="stat-label text-slate-400">Gemini API Calls</span>
                    </div>
                </div>

                <!-- IP Address Breakdown -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-slate-200 border-b border-slate-700 pb-2">IP Address Breakdown</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-700/50">
                                <tr>
                                    <th class="p-3 font-semibold">IP Address</th>
                                    <th class="p-3 font-semibold text-right">Total Photos Inputted</th>
                                </tr>
                            </thead>
                            <tbody id="ipTableBody">
                                <!-- Rows will be injected here by JavaScript -->
                            </tbody>
                        </table>
                         <p id="noIpData" class="text-center text-slate-500 italic py-6 hidden">No photo input data for the selected period.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const WORKER_URL = 'https://status-tracker.aurtho.com/query'; // IMPORTANT: Update this with your new worker's URL

            // --- DOM Elements ---
            const dom = {
                monthSelect: document.getElementById('monthSelect'),
                yearSelect: document.getElementById('yearSelect'),
                searchButton: document.getElementById('searchButton'),
                loader: document.getElementById('loader'),
                errorMessage: document.getElementById('errorMessage'),
                statsContainer: document.getElementById('statsContainer'),
                todayPhotos: document.getElementById('todayPhotos'),
                monthPhotos: document.getElementById('monthPhotos'),
                monthGeminiCalls: document.getElementById('monthGeminiCalls'),
                ipTableBody: document.getElementById('ipTableBody'),
                noIpData: document.getElementById('noIpData'),
            };

            // --- Initialization ---
            function initialize() {
                populateDateSelectors();
                fetchStats();
                dom.searchButton.addEventListener('click', fetchStats);
            }

            // --- Core Functions ---
            function populateDateSelectors() {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                // Populate months
                const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                months.forEach((month, index) => {
                    const option = new Option(month, index + 1);
                    if (index === currentMonth) option.selected = true;
                    dom.monthSelect.add(option);
                });

                // Populate years
                for (let year = currentYear; year >= 2023; year--) {
                    dom.yearSelect.add(new Option(year, year));
                }
            }

            async function fetchStats() {
                const year = dom.yearSelect.value;
                const month = dom.monthSelect.value;

                showLoader(true);
                showError(false);
                dom.statsContainer.classList.add('hidden');

                const urlToFetch = `${WORKER_URL}?year=${year}&month=${month}`;

                try {
                    const response = await fetch(urlToFetch, { mode: 'cors' }); // Explicitly set mode to 'cors'

                    if (!response.ok) {
                        // Try to get a more detailed error message from the worker
                        const errorText = await response.text();
                        let errorData = { error: `Server error (${response.status})` };
                        try {
                            // Check if the error response is valid JSON
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            // If not JSON, use the raw text as the error message
                            console.error("Non-JSON error response from worker:", errorText);
                        }
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    renderStats(data);
                } catch (error) {
                    console.error('Fetch error:', error);
                    // Provide a more helpful, user-facing error message
                    let friendlyMessage = `Error: ${error.message}`;
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        friendlyMessage = 'Could not connect to the statistics server. This may be a CORS issue, an incorrect worker URL, or a network problem. Please verify the worker is active and reachable.';
                    }
                    showError(true, friendlyMessage);
                } finally {
                    showLoader(false);
                }
            }

            function renderStats(data) {
                dom.statsContainer.classList.remove('hidden');

                // Animate numbers
                animateValue(dom.todayPhotos, data.todayPhotos);
                animateValue(dom.monthPhotos, data.monthPhotos);
                animateValue(dom.monthGeminiCalls, data.monthGeminiCalls);

                // Render IP table
                dom.ipTableBody.innerHTML = '';
                if (data.ipBreakdown && data.ipBreakdown.length > 0) {
                    dom.noIpData.classList.add('hidden');
                    data.ipBreakdown.forEach(item => {
                        const row = `
                            <tr class="border-b border-slate-700 hover:bg-slate-700/30">
                                <td class="p-3">${item.ip_address}</td>
                                <td class="p-3 text-right font-semibold">${item.count.toLocaleString()}</td>
                            </tr>
                        `;
                        dom.ipTableBody.innerHTML += row;
                    });
                } else {
                     dom.noIpData.classList.remove('hidden');
                }
            }

            // --- UI Helpers ---
            function showLoader(visible) {
                dom.loader.classList.toggle('hidden', !visible);
            }
            
            function showError(visible, message = '') {
                dom.errorMessage.textContent = message;
                dom.errorMessage.classList.toggle('hidden', !visible);
            }
            
            function animateValue(element, endValue) {
                let startValue = parseInt(element.textContent) || 0;
                if (startValue === endValue) return;
                
                const duration = 1000;
                const range = endValue - startValue;
                let startTime = null;

                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const currentValue = Math.floor(progress * range + startValue);
                    element.textContent = currentValue.toLocaleString();
                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        element.textContent = endValue.toLocaleString();
                    }
                }
                requestAnimationFrame(step);
            }

            initialize();
        });
    </script>
</body>
</html>

