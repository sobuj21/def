<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>Data Extractor & Formatter</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Ctext%20x='50%25'%20y='50%25'%20dominant-baseline='central'%20text-anchor='middle'%20font-size='85'%20font-family='sans-serif'%20font-weight='bold'%20fill='%2360a5fa'%3ED%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .copy-btn.copied { background-color: #22c55e; color: white; }
        .output-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .output-item:last-child { border-bottom: none; }
        .output-label { font-weight: 600; margin-right: 0.5rem; white-space: nowrap; flex-shrink: 0; }
        .output-value { flex-grow: 1; text-align: left; word-break: break-word; margin-right: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .output-value[contenteditable="true"] { outline: 2px solid #60a5fa; background-color: #374151; }
        .output-value.needs-review, .output-value.suggested-invalid-hex { color: #f87171; }
        .btn, .copy-btn, .edit-btn, .search-btn { margin-left: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.8rem; transition: background-color 0.2s ease, color 0.2s ease; flex-shrink: 0; border-radius: 0.375rem; cursor: pointer; }
        .filename-section { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-radius: 0.375rem; }
        #filenameOutput { flex-grow: 1; margin-right: 1rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        #filenameOutput[contenteditable="true"] { outline: 2px solid #60a5fa; background-color: #374151; }
        #pageTitle { cursor: pointer; user-select: none; }
        #imageUploadLabel { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s ease; display: inline-block; text-align: center; }
        #imageInput { display: none; }
        .loader { border: 4px solid #4A5568; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; vertical-align: middle; }
        .hex-loader { border: 2px solid #4A5568; border-top: 2px solid #3498db; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .processing { opacity: 0.7; cursor: not-allowed; }
        #dropZone { border-radius: 0.5rem; padding: 1.5rem; text-align: center; transition: background-color 0.2s ease, border-color 0.2s ease; }
        #dropZone p { margin-bottom: 0.75rem; }
        #previewImageElement { max-width: 100%; height: auto; max-height: 70vh; }
        .btn-icon { width: 1rem; height: 1rem; }
        body.dragging::before { content: 'Drop Image Anywhere to Process'; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(16, 24, 40, 0.9); color: white; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; z-index: 9999; pointer-events: none; border: 4px dashed #60a5fa; box-sizing: border-box; }
    </style>
</head>

<body class="bg-slate-900 min-h-screen p-4 md:p-8 flex items-center justify-center transition-colors duration-300">
    <div class="bg-slate-800 p-6 md:p-8 rounded-lg shadow-lg w-full max-w-2xl relative transition-colors duration-300">
        <header class="flex items-center justify-center mb-6">
            <h1 id="pageTitle" class="text-2xl font-semibold text-slate-200" title="Click to reset form (or press Backspace outside inputs)">Data Extractor & Formatter</h1>
            <a href="https://c.aurtho.com" target="_blank" rel="noopener noreferrer" class="ml-3 p-1 rounded-full hover:bg-slate-700 transition-colors" title="Visit C Website">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" /></svg>
            </a>
        </header>

        <main>
            <div class="mb-4">
                <label for="dataInput" class="block text-sm font-medium text-slate-300 mb-1">Paste your data here:</label>
                <div class="flex items-center space-x-2">
                    <textarea id="dataInput" rows="6" class="flex-grow p-3 border border-slate-600 rounded-md shadow-sm focus:ring-indigo-400 focus:border-indigo-400 text-sm resize-y bg-slate-700 text-slate-100 placeholder-slate-400" placeholder="Example:&#10;SKU: DC-CTO-25&#10;Font Style: Snap ITC&#10;..."></textarea>
                    <button id="pasteButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 dark:ring-offset-slate-800 transition duration-150 ease-in-out text-sm">Paste</button>
                </div>
            </div>

            <div class="my-4 flex items-center">
                <div class="flex-grow border-t border-slate-600"></div><span class="flex-shrink mx-4 text-slate-400 text-sm">OR</span><div class="flex-grow border-t border-slate-600"></div>
            </div>

            <div id="dropZone" class="mb-6 bg-slate-700 border-2 border-dashed border-slate-600">
                <p class="text-sm text-slate-400">Drag & Drop an image</p>
                <label for="imageInput" id="imageUploadLabel" class="bg-blue-600 hover:bg-blue-700 text-white">Choose Image</label>
                <input type="file" id="imageInput" accept="image/*">
                <span id="fileName" class="block text-sm text-slate-400 italic mt-2">No file chosen</span>
                <p class="text-xs text-slate-500 mt-1">Image text will be extracted on submit. Accuracy depends on image quality.</p>
            </div>

            <div class="flex justify-end mb-6">
                <button id="submitButton" class="px-5 py-2 bg-green-700 text-white rounded-md hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 dark:ring-offset-slate-800 transition duration-150 ease-in-out font-medium flex items-center justify-center">
                    <span>Submit</span><div id="submitSpinner" class="loader hidden"></div>
                </button>
            </div>

            <section id="outputSection" class="space-y-4 hidden">
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-slate-200 border-b border-slate-700 pb-2 flex items-center">
                        <span>Extracted Information</span>
                        <span id="ocrWarning" class="ml-2 text-yellow-400 hidden" title="Potential OCR issues detected. Please verify extracted data."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" /></svg></span>
                        <span id="ocrWarningHint" class="ml-1 text-xs text-yellow-500"></span>
                    </h2>
                    <div id="extractedInfo" class="space-y-1 bg-slate-700/50 p-4 rounded-md shadow-inner"></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-slate-200 border-b border-slate-700 pb-2">Generated Filename</h2>
                    <div class="filename-section bg-slate-700/50">
                        <div id="filenameOutput" class="text-sm text-slate-200 break-words" contenteditable="false"></div>
                        <button id="editFilenameButton" class="edit-btn p-1 bg-slate-600 text-slate-200 hover:bg-slate-500" title="Edit Filename">
                            <svg class="btn-icon" id="editIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" /></svg>
                            <svg class="btn-icon hidden" id="saveIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="copyFilenameButton" class="copy-btn bg-slate-600 text-slate-200 hover:bg-slate-500">Copy</button>
                    </div>
                </div>
            </section>
            
            <section id="imagePreviewSection" class="mt-6 hidden">
                <h2 class="text-lg font-semibold mb-3 text-slate-200 border-b border-slate-700 pb-2">Image Preview</h2>
                <div class="bg-slate-700/50 p-4 rounded-md shadow-inner flex justify-center items-center">
                    <img id="previewImageElement" src="#" alt="Image Preview" class="rounded-md">
                </div>
            </section>
        </main>
        
        <footer class="mt-4 text-center">
            <div id="messageBox" class="text-sm font-medium hidden"></div>
            <div id="ocrSourceDisplay" class="text-xs text-slate-500 mt-2"></div>
        </footer>
    </div>

    <script>
    (function() {
        // --- CONFIGURATION & STATE ---
        const WORKER_URL = 'https://gemini-api.aurtho.com/';
        const RETRY_DELAY_MS = 3000;
        const OCR_TIMEOUT_MS = 40000;
        const dom = { body: document.body, dataInput: document.getElementById('dataInput'), pasteButton: document.getElementById('pasteButton'), submitButton: document.getElementById('submitButton'), outputSection: document.getElementById('outputSection'), extractedInfo: document.getElementById('extractedInfo'), filenameOutput: document.getElementById('filenameOutput'), copyFilenameButton: document.getElementById('copyFilenameButton'), editFilenameButton: document.getElementById('editFilenameButton'), editIcon: document.getElementById('editIcon'), saveIcon: document.getElementById('saveIcon'), messageBox: document.getElementById('messageBox'), pageTitle: document.getElementById('pageTitle'), imageInput: document.getElementById('imageInput'), fileName: document.getElementById('fileName'), submitSpinner: document.getElementById('submitSpinner'), dropZone: document.getElementById('dropZone'), ocrWarning: document.getElementById('ocrWarning'), ocrWarningHint: document.getElementById('ocrWarningHint'), imagePreviewSection: document.getElementById('imagePreviewSection'), previewImageElement: document.getElementById('previewImageElement'), ocrSourceDisplay: document.getElementById('ocrSourceDisplay') };
        let appState = { isProcessing: false, selectedFile: null, processedData: {} };
        const commonColorHexMap = {'indian red':'#CD5C5C','light coral':'#F08080','salmon':'#FA8072','dark salmon':'#E9967A','light salmon':'#FFA07A','crimson':'#DC143C','red':'#FF0000','matte red':'#B33F40','glossy red':'#DD0004','light red':'#C91100','metallic red':'#B71C1C','fire brick':'#B22222','dark red':'#8B0000','alabama crimson':'#AF002A','pink':'#FFC0CB','matte pink':'#EC407A','glossy pink':'#FF35B8','metallic pink':'#AD1457','light pink':'#FFB6C1','hot pink':'#FF69B4','deep pink':'#FF1493','medium violet red':'#C71585','pale violet red':'#DB7093','soft pink':'#FFB8BF','matte soft pink':'#D288A2','coral':'#FF7F50','tomato':'#FF6347','orange red':'#FF4500','dark orange':'#FF8C00','orange':'#FFA500','matte orange':'#ED944D','metallic orange':'#E65100','gold':'#FFD700','yellow':'#FFFF00','matte yellow':'#FBC02D','metallic yellow':'#F9A825','matte gold':'#D2BF37','glossy yellow':'#FFF158','light yellow':'#FFFFE0','lemon chiffon':'#FFFACD','papaya whip':'#FFEFD5','moccasin':'#FFE4B5','peach puff':'#FFDAB9','pale goldenrod':'#EEE8AA','khaki':'#F0E68C','dark khaki':'#BDB76B','brimstone yellow':'#F4D83F','green yellow':'#ADFF2F','chartreuse':'#7FFF00','lawn green':'#7CFC00','lime':'#00FF00','matte lime':'#AFB42B','metallic lime':'#827717','lime green':'#32CD32','lime-tree green':'#7CBF4E','pale green':'#98FB98','light green':'#90EE90','medium spring green':'#00FA9A','spring green':'#00FF7F','medium sea green':'#3CB371','sea green':'#2E8B57','forest green':'#228B22','green':'#00BF00','matte green':'#48A14D','metallic green':'#1B5E20','dark green':'#006400','yellow green':'#9ACD32','olive drab':'#6B8E23','olive':'#808000','dark olive green':'#556B2F','dark sea green':'#8FBC8F','light sea green':'#20B2AA','dark cyan':'#008B8B','teal':'#008080','acid green':'#B0BF1A','aqua':'#00FFFF','cyan':'#00FFFF','matte cyan':'#00ACC1','metallic cyan':'#00838F','light cyan':'#E0FFFF','pale turquoise':'#AFEEEE','aquamarine':'#7FFFD4','turquoise':'#40E0D0','medium turquoise':'#48D1CC','dark turquoise':'#00CED1','zomp':'#39A78E','cadet blue':'#5F9EA0','steel blue':'#4682B4','light steel blue':'#B0C4DE','powder blue':'#B0E0E6','light blue':'#ADD8E6','sky blue':'#87CEEB','light sky blue':'#87CEFA','matte sky blue':'#7AAEC4','deep sky blue':'#00BFFF','dodger blue':'#1E90FF','cornflower blue':'#6495ED','matte turquoise':'#5FBDB1','medium slate blue':'#7B68EE','king blue':'#152A78','royal blue':'#4169E1','blue':'#0000FF','deep sea blue':'#015482','deep sea blue color':'#256794','matte blue':'#1976D2','metallic blue':'#0D47A1','medium blue':'#0000CD','dark blue':'#00008B','navy':'#000080','matte navy':'#283593','metallic navy':'#1A237E','midnight blue':'#191970','matte dark blue':'#0B0B60','brilliant blue':'#2752D6','air superiority blue':'#72A0C1','aero blue':'#C9FFE5','air force blue (raf)':'#5D8AA8','absolute zero':'#0048BA','aero':'#7CB9E8','zaffre':'#0014A8','lavender':'#D3D3FF','thistle':'#D8BFD8','plum':'#DDA0DD','violet':'#EE82EE','matte violet':'#8658A5','orchid':'#DA70D6','fuchsia':'#FF00FF','magenta':'#FF00FF','matte magenta':'#C2185B','metallic magenta':'#880E4F','medium orchid':'#BA55D3','medium purple':'#9370DB','rebecca purple':'#663399','blue violet':'#8A2BE2','dark violet':'#9400D3','dark orchid':'#9932CC','dark magenta':'#8B008B','purple':'#800080','matte purple':'#7B1FA2','metallic purple':'#4A148C','indigo':'#4B0082','slate blue':'#6A5ACD','dark slate blue':'#483D8B','burgundy':'#800020','matte burgundy':'#691C2D','glossy burgundy':'#800020','african violet':'#B284BE','cornsilk':'#FFF8DC','blanched almond':'#FFEBCD','bisque':'#FFE4C4','navajo white':'#FFDEAD','wheat':'#F5DEB3','burly wood':'#DEB887','tan':'#D2B48C','rosy brown':'#BC8F8F','sandy brown':'#F4A460','goldenrod':'#DAA520','dark goldenrod':'#B8860B','peru':'#CD853F','chocolate':'#D2691E','saddle brown':'#8B4513','sienna':'#A0522D','brown':'#A52A2A','matte brown':'#5D4037','metallic copper':'#D1793B','metallic brown':'#3E2723','maroon':'#800000','zinnwaldite brown':'#2C1608','white':'#F0F0F0','matte white':'#F0F0F0','metallic white':'#ECEFF1','snow':'#FFFAFA','honey dew':'#F0FFF0','mint cream':'#F5FFFA','mint':'#3EB489','azure':'#F0FFFF','alice blue':'#F0F8FF','ghost white':'#F8F8FF','white smoke':'#F5F5F5','sea shell':'#FFF5EE','beige':'#F5F5DC','old lace':'#FDF5E6','floral white':'#FFFAF0','ivory':'#FFFFF0','antique white':'#FAEBD7','linen':'#FAF0E6','lavender blush':'#FFF0F5','gainsboro':'#DCDCDC','light gray':'#D3D3D3','silver':'#C0C0C0','dark gray':'#A9A9A9','gray':'#808080','grey':'#808080','matte gray':'#757575','metallic gray':'#616161','silver gray metallic':'#8A92A6','dim gray':'#696969','lavender gray':'#C3C5C9','light slate gray':'#778899','slate gray':'#708090','dark slate gray':'#2F4F4F','black':'#000000','matte black':'#28282B','velvet black':'#171717','metallic black':'#424242','glossy cream':'#FFFDD0','light brown':'#C4A484','gold metallic':'#D4AF37','glossy sky blue':'#87CEEB','glossy light blue':'#87C1FF','electric bright sky blue':'#56DEFF'};
        const knownColorKeywords = new Set();
        const hexCache = { get: () => JSON.parse(localStorage.getItem('hexCodeCache') || '{}'), save: (cache) => localStorage.setItem('hexCodeCache', JSON.stringify(cache)) };

        // --- CORE LOGIC ---

        function initializeApp() {
            const colorWords = ['red','orange','yellow','green','blue','purple','violet','pink','brown','black','white','gray','grey','cyan','magenta','teal','lime','olive','maroon','navy','aqua','fuchsia','silver','gold','khaki','coral','salmon','ivory','beige','azure','indigo','plum','orchid','thistle','sienna','peru','tan','wheat','cream','amber','bronze','copper','charcoal','cobalt','coffee','emerald','jade','lavender','lemon','lilac','mustard','ochre','peach','pearl','rose','ruby','sapphire','scarlet','taupe','turquoise','ultramarine','vermilion','viridian','mint','tree'];
            const modifiers = ['light','dark','deep','pale','medium','bright','soft','hot','sky','sea','spring','forest','electric','metallic','matte','glossy','powder','drab','chiffon','crimson','royal','slate','steel','smoke','ish','color'];
            [...Object.keys(commonColorHexMap), ...colorWords, ...modifiers].forEach(key => key.toLowerCase().split(/[\s-]+/).forEach(word => word && knownColorKeywords.add(word.replace(/[^a-z0-9]/g, ''))));
            setupEventListeners();
        }

        async function handleSubmit() {
            if (appState.isProcessing) return;
            setProcessingState(true);
            clearOutput();
            try {
                const inputText = dom.dataInput.value.trim();
                if (inputText) {
                    await processInputText(inputText);
                } else if (appState.selectedFile) {
                    await processImage(appState.selectedFile);
                } else {
                    showMessage('Please paste text or upload an image.', true);
                }
            } catch (error) {
                 if (!error.message.includes("Configuration error")) {
                    showMessage(`An unexpected error occurred. See console for details.`, true, 5000);
                 }
            } finally {
                setProcessingState(false);
            }
        }

        async function processImage(imageFile) {
            try {
                const base64ImageData = await imageToBase64(imageFile);
                let ocrText = '';
                try {
                    setProcessingState(true, 'Running Gemini OCR...');
                    ocrText = await callWorkerForOcr(base64ImageData, imageFile.type);
                    appState.ocrSource = 'Gemini';
                } catch (error) {
                    console.error("Primary OCR failed. Reason:", error.message);
                    if (error.message.includes("Worker environment is not configured")) {
                        const detailedError = `<strong>Configuration Error:</strong> Your secure API worker is not set up correctly. <br><br> Please go to your Cloudflare dashboard and verify: <br>1. In 'gemini-api-proxy' Worker > Settings > Variables, you have a variable named <strong>GEMINI_API_KEYS</strong>. <br>2. In the same section, a KV Namespace Binding named <strong>KEY_STATUS</strong> is connected.`;
                        showMessage(detailedError, true, 0);
                        throw new Error("Configuration error displayed to user.");
                    }
                    let fallbackMessage = 'Secure API failed. Falling back to Tesseract OCR...';
                    if (error.name === 'AbortError') fallbackMessage = `API took too long (>40s). Falling back to Tesseract...`;
                    else if (error.message.includes("cooldown") || error.message.includes("failed to process")) fallbackMessage = `All API keys are busy. Falling back to Tesseract...`;
                    else if (error.message.includes("RETRY_FAILED")) fallbackMessage = `Secure API is overloaded. Falling back to Tesseract...`;
                    showMessage(fallbackMessage, false, 5000);
                    ocrText = await runTesseractOcr(imageFile);
                    appState.ocrSource = 'Tesseract';
                }
                await processInputText(ocrText);
            } catch (error) {
                if (!error.message.includes("Configuration error")) {
                    showMessage(`Image processing failed: ${error.message}`, true, 5000);
                }
                throw error;
            }
        }

        async function processInputText(text) {
            if (!text) { showMessage('Input text is empty.', true); return; }
            const keyMap = {"SKU:":"sku","Font Style:":"fontStyle","Your custom text:":"customText","Input your custom text here.:":"customText","Text Color:":"textColorFull","Colors:":"textColorFull","Text Outline Color:":"outlineColorFull","Outline Colors:":"outlineColorFull","Size:":"size"};
            const raw = {};
            text.split('\n').forEach(line => {
                const trimmed = line.trim();
                if (!trimmed || ["Customizations:", "Surface 1:"].some(n => trimmed.startsWith(n))) return;
                for (const key in keyMap) {
                    if (trimmed.toLowerCase().startsWith(key.toLowerCase())) { raw[keyMap[key]] = trimmed.substring(key.length).trim(); return; }
                }
            });
            const textColor = parseColorValue(raw.textColorFull);
            const outlineColor = parseColorValue(raw.outlineColorFull);
            const size = formatSize(raw.size);
            appState.processedData = { sku: (raw.sku || "NoSKU").replace(/_/g, '-').replace('SC-MTO-25', 'SC-MСТО-25'), fontStyle: raw.fontStyle || null, customText: raw.customText || null, textColorDescriptive: textColor.descriptive, textColorHex: textColor.hex, outlineColorDescriptive: outlineColor.descriptive, outlineColorHex: raw.outlineColorFull ? outlineColor.hex : null, sizeDisplay: size.display, sizeFilename: size.filename, originalInput: text };
            renderOutput();
            await fetchHexCodesAsync();
        }
        
        async function fetchHexCodesAsync() {
            const { textColorDescriptive, outlineColorDescriptive } = appState.processedData;
            const promises = [];
            if (textColorDescriptive && appState.processedData.textColorHex === 'loading') {
                promises.push(getHexCode(textColorDescriptive).then(hex => { appState.processedData.textColorHex = hex; }));
            }
            if (outlineColorDescriptive && appState.processedData.outlineColorHex === 'loading') {
                promises.push(getHexCode(outlineColorDescriptive).then(hex => { appState.processedData.outlineColorHex = hex; }));
            }
            if (promises.length > 0) {
                 await Promise.all(promises);
                 renderOutput();
            }
        }
        
        function parseColorValue(value) {
            if (!value) return { descriptive: null, hex: null };
            let str = value.replace(/^(?:Please\s+)?ignore\s+this\s+color.*$/i, '').trim();
            const hex = (str.match(/#([A-Fa-f0-9]{6})\b/) || [])[0] || null;
            const descriptive = cleanColorName(str.replace(hex || '', ''));
            return { descriptive, hex: hex || 'loading' };
        }

        function cleanColorName(name) {
            if (!name) return "";
            let cleaned = name.replace(/\s*\(.*?\)|#\s*[A-Fa-f0-9]+/gi, ' ').replace(/([a-zA-Z])(\d)/g, '$1 $2');
            let words = cleaned.split(/\s+/).filter(word => {
                const cleanWord = word.toLowerCase().replace(/[^a-z0-9-]/g, '');
                return knownColorKeywords.has(cleanWord) || (word.includes('-') && word.split('-').every(p => knownColorKeywords.has(p.toLowerCase().replace(/[^a-z0-9]/g, '')) || p === ""));
            });
            cleaned = words.join(' ').replace(/\s+/g, ' ').trim();
            return cleaned.split(' ').map(w => w.toUpperCase() === 'SC' || w.toUpperCase() === 'ITC' ? w.toUpperCase() : w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }
        
        function formatSize(rawSize) {
            if (!rawSize) return { display: null, filename: "" };
            let str = rawSize.replace(/Option to Add Complimentary Free Squeegee/gi, "").trim();
            let display = str.replace(/\s*\([^)]*\)\s*/g, ' ').replace(/\bINCHES\b/gi, 'INCH').replace(/\s*("|\u201D)\s*/g, ' INCH ').replace(/[^a-zA-Z0-9\s.-]/g, ' ').replace(/\s+/g, ' ').trim();
            let filename = display.replace(/\b(length|long)\b/gi, 'L').replace(/\bheight\b/gi, 'H').replace(/\bwidth\b/gi, 'W');
            return { display, filename };
        }

        function generateFilename() {
            const { customText, textColorDescriptive, outlineColorDescriptive, sizeFilename, sku } = appState.processedData;
            const cleanColor = (c) => c ? c.replace(/[^a-zA-Z0-9\s-]/g, '').trim() : "";
            const parts = [ customText || "NoText", cleanColor(textColorDescriptive) ? `(TC-${cleanColor(textColorDescriptive)})` : "", cleanColor(outlineColorDescriptive) ? `(TOC-${cleanColor(outlineColorDescriptive)})` : "", sizeFilename ? `(S-${sizeFilename})` : "", `(${(sku || "NoSKU")})` ];
            return parts.join('').replace(/[<>:"/\\|?*\x00-\x1F]/g, '');
        }

        async function callWorkerWithRetries(payload) {
            const jsonBody = JSON.stringify(payload);
            if (!jsonBody || jsonBody === '{}') throw new Error("Client-side error: Aborting send due to empty payload.");
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), OCR_TIMEOUT_MS);
            try {
                const response = await fetch(WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: jsonBody, signal: controller.signal });
                if (response.status >= 500) {
                    const errorBody = await response.json().catch(() => ({}));
                    if (errorBody.error && (errorBody.error.includes("cooldown") || errorBody.error.includes("failed to process"))) throw new Error(errorBody.error);
                    console.warn(`Worker returned server error ${response.status}. Retrying...`);
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                    const retryResponse = await fetch(WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: jsonBody, signal: controller.signal });
                    if (!retryResponse.ok) {
                        const retryErrorBody = await retryResponse.json().catch(() => ({}));
                        throw new Error("RETRY_FAILED: " + (retryErrorBody.error || `Retry failed with status: ${retryResponse.status}`));
                    }
                    return retryResponse.json();
                }
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    throw new Error(errorBody.error || `Worker error: ${response.status}`);
                }
                return response.json();
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function callWorkerForOcr(imageData, mimeType) {
            const result = await callWorkerWithRetries({ endpoint: 'ocr', imageData, mimeType });
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
            throw new Error("Invalid OCR response from server.");
        }
        
        async function getHexCode(descriptiveColor, bypassCache = false) {
            if (!descriptiveColor) return "N/A";
            const canonical = descriptiveColor.toLowerCase().split(/\s+/).filter(Boolean).sort().join(" ");
            const cache = hexCache.get();
            if (!bypassCache && cache[canonical] && new Date().getTime() < cache[canonical].expiry) return cache[canonical].hex;
            try {
                const result = await callWorkerWithRetries({ endpoint: 'hex', colorName: descriptiveColor });
                const hex = result.candidates?.[0]?.content?.parts?.[0]?.text.trim();
                if (/^#([A-Fa-f0-9]{6})$/.test(hex)) {
                    const expiry = new Date().getTime() + (30 * 24 * 60 * 60 * 1000);
                    const currentCache = hexCache.get();
                    currentCache[canonical] = { hex, expiry };
                    hexCache.save(currentCache);
                    return hex;
                }
            } catch (error) { console.warn(`Worker hex generation failed for "${descriptiveColor}".`, error); }
            for (const key in commonColorHexMap) if (key.toLowerCase().split(/\s+/).filter(Boolean).sort().join(" ") === canonical) return commonColorHexMap[key];
            return "N/A";
        }
        
        async function runTesseractOcr(file) {
            setProcessingState(true, 'Running Tesseract OCR...');
            const worker = await Tesseract.createWorker('eng+rus');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        }

        function renderOutput() {
            dom.extractedInfo.innerHTML = '';
            const { sku, fontStyle, customText, textColorDescriptive, textColorHex, outlineColorDescriptive, outlineColorHex, sizeDisplay, originalInput } = appState.processedData;
            const createRow = (label, value, dataKey, copyValue = null, needsReview = false, descColorForSearch = null) => {
                if (value === null || value === undefined) return;
                const row = document.createElement('div');
                row.className = 'output-item border-b border-slate-700';
                const valueHTML = value === 'loading' ? `<div class="hex-loader"></div> Generating...` : String(value);
                row.innerHTML = `<span class="output-label text-slate-400">${label}:</span><span class="output-value text-slate-100 flex-grow ${needsReview ? (label.includes('Hex') ? 'suggested-invalid-hex' : 'needs-review') : ''}" data-original-value="${String(value)}">${valueHTML}</span><div class="flex items-center flex-shrink-0">${label.includes("Hex Code") ? `<button class="search-btn p-1 bg-slate-600 text-slate-200 hover:bg-slate-500" title="Search again for ${descColorForSearch}"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg></button>` : ''}<button class="edit-btn p-1 bg-slate-600 text-slate-200 hover:bg-slate-500" title="Edit ${label}"><svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" /></svg><svg class="btn-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg></button><button class="copy-btn bg-slate-600 text-slate-200 hover:bg-slate-500">Copy</button></div>`;
                dom.extractedInfo.appendChild(row);
                row.querySelector('.search-btn')?.addEventListener('click', async () => { appState.processedData[dataKey] = 'loading'; renderOutput(); appState.processedData[dataKey] = await getHexCode(descColorForSearch, true); renderOutput(); });
                row.querySelector('.edit-btn').addEventListener('click', (e) => handleValueEdit(row.querySelector('.output-value'), e.currentTarget, dataKey, label));
                row.querySelector('.copy-btn').addEventListener('click', (e) => copyToClipboard(copyValue !== null ? String(copyValue) : String(value), e.currentTarget));
            };

            const outlineInSource = originalInput?.toLowerCase().includes("outline");
            createRow('SKU', sku, 'sku');
            createRow('Font Style', fontStyle, 'fontStyle');
            createRow('Your custom text', customText, 'customText');
            createRow('Text Color', textColorDescriptive, 'textColorDescriptive');
            if (textColorDescriptive && textColorDescriptive.toLowerCase() !== 'black') createRow('Text Hex Code', textColorHex, 'textColorHex', textColorHex, textColorHex !== 'loading' && !/^#([A-Fa-f0-9]{6})$/.test(textColorHex), textColorDescriptive);
            if (outlineInSource) {
                 createRow('Text Outline Color', outlineColorDescriptive, 'outlineColorDescriptive');
                if (outlineColorDescriptive && outlineColorDescriptive.toLowerCase() !== 'black') createRow('Text Outline Hex Code', outlineColorHex, 'outlineColorHex', outlineColorHex, outlineColorHex !== 'loading' && !/^#([A-Fa-f0-9]{6})$/.test(outlineColorHex), outlineColorDescriptive);
            }
            createRow('Size', sizeDisplay, 'sizeDisplay');
            if (dom.extractedInfo.children.length === 0) dom.extractedInfo.innerHTML = `<p class="text-slate-400 italic p-2">No relevant information could be extracted.</p>`;
            dom.filenameOutput.textContent = generateFilename();
            dom.ocrSourceDisplay.textContent = appState.ocrSource ? `By ${appState.ocrSource}` : '';
            dom.outputSection.classList.remove('hidden');
            dom.outputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (appState.selectedFile) { renderOcrWarning(); dom.imagePreviewSection.classList.remove('hidden'); }
        }

        function renderOcrWarning() {
            const { sku, fontStyle, customText, textColorDescriptive, textColorHex, sizeDisplay, originalInput } = appState.processedData;
            const issues = [];
            if (!sku || sku === "NoSKU") issues.push("SKU");
            if (!fontStyle) issues.push("Font Style");
            if (!customText || /\s{2,}|(?:\b[A-Z]\s){2,}[A-Z]\b/.test(customText)) issues.push("Custom Text");
            if (originalInput.toLowerCase().includes("color") && !textColorDescriptive) issues.push("Text Color");
            if (textColorDescriptive && textColorHex !== 'loading' && !/^#([A-Fa-f0-9]{6})$/.test(textColorHex)) issues.push("Text Hex");
            if (originalInput.toLowerCase().includes("size") && (!sizeDisplay || !sizeDisplay.includes('L') || !sizeDisplay.includes('H'))) issues.push("Size");
            dom.ocrWarning.classList.toggle('hidden', issues.length === 0);
            dom.ocrWarningHint.textContent = issues.length > 0 ? `Check: ${issues.join(', ')}` : '';
        }

        function handleFileSelect(file) {
            if (file?.type.startsWith('image/')) {
                resetForm();
                appState.selectedFile = file;
                dom.fileName.textContent = file.name;
                dom.dataInput.value = '';
                dom.previewImageElement.src = URL.createObjectURL(file);
                handleSubmit();
            } else showMessage('Please select or drop a valid image file.', true);
        }
        
        async function handleValueEdit(valueSpan, button, dataKey, label) {
            const isEditing = valueSpan.isContentEditable;
            const [editSvg, saveSvg] = button.children;
            valueSpan.contentEditable = !isEditing;
            saveSvg.classList.toggle('hidden', isEditing); editSvg.classList.toggle('hidden', !isEditing);
            button.title = isEditing ? `Edit ${label}` : `Save ${label}`;
            if (isEditing) {
                valueSpan.classList.remove('focus:ring-2', 'focus:ring-indigo-400', 'bg-slate-700', 'needs-review');
                const newValue = valueSpan.textContent.trim();
                appState.processedData[dataKey] = newValue;
                if (dataKey.includes('Descriptive')) { appState.processedData[dataKey.replace('Descriptive', 'Hex')] = 'loading'; }
                renderOutput(); 
                await fetchHexCodesAsync();
            } else { valueSpan.classList.add('focus:ring-2', 'focus:ring-indigo-400', 'bg-slate-700'); valueSpan.focus(); document.execCommand('selectAll', false, null); }
        }
        
        function handleFilenameEdit(isEditing) {
             dom.filenameOutput.contentEditable = !isEditing;
             dom.saveIcon.classList.toggle('hidden', isEditing); dom.editIcon.classList.toggle('hidden', !isEditing);
             dom.editFilenameButton.title = isEditing ? "Edit Filename" : "Save Filename";
             dom.filenameOutput.classList.toggle('focus:ring-2', !isEditing); dom.filenameOutput.classList.toggle('focus:ring-indigo-400', !isEditing); dom.filenameOutput.classList.toggle('bg-slate-700', !isEditing);
             if (!isEditing) { dom.filenameOutput.focus(); document.execCommand('selectAll', false, null); }
        }
        
        function resetForm() {
            appState = { isProcessing: false, selectedFile: null, processedData: {} };
            dom.dataInput.value = ''; dom.imageInput.value = ''; dom.fileName.textContent = 'No file chosen';
            clearOutput(); 
            showMessage('Form reset.', false, 3000);
        }

        function clearOutput() {
            dom.outputSection.classList.add('hidden'); dom.imagePreviewSection.classList.add('hidden');
            dom.extractedInfo.innerHTML = ''; dom.filenameOutput.textContent = '';
            dom.ocrWarning.classList.add('hidden'); dom.ocrWarningHint.textContent = '';
            dom.ocrSourceDisplay.textContent = '';
        }

        function setProcessingState(isProcessing, message = 'Processing...') {
            appState.isProcessing = isProcessing;
            dom.submitButton.disabled = isProcessing;
            dom.submitButton.classList.toggle('processing', isProcessing);
            dom.submitSpinner.classList.toggle('hidden', !isProcessing);
            if (isProcessing) {
                showMessage(message, false, 0);
            } else {
                clearTimeout(dom.messageBox.timeoutId);
                dom.messageBox.classList.add('hidden');
            }
        }

        function showMessage(text, isError = false, duration = 3000) {
            clearTimeout(dom.messageBox.timeoutId);
            dom.messageBox.innerHTML = text;
            dom.messageBox.className = `p-4 rounded-md mt-4 text-center text-sm font-medium ${isError ? 'bg-red-900/50 border border-red-700 text-red-300' : 'text-green-400'}`;
            dom.messageBox.classList.remove('hidden');
            if (duration > 0) {
                dom.messageBox.timeoutId = setTimeout(() => dom.messageBox.classList.add('hidden'), duration);
            }
        }
        
        async function copyToClipboard(text, button) {
            if (!text) return showMessage('Nothing to copy.', true);
            const originalText = button.textContent;
            button.textContent = 'Copied!'; button.classList.add('copied');
            try { await navigator.clipboard.writeText(text); } catch (err) { showMessage('Failed to copy.', true); }
            finally { setTimeout(() => { button.textContent = originalText; button.classList.remove('copied'); }, 1500); }
        }

        const imageToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
        
        function setupEventListeners() {
            dom.submitButton.addEventListener('click', handleSubmit);
            dom.pageTitle.addEventListener('click', resetForm);
            dom.imageInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            dom.pasteButton.addEventListener('click', async () => { try { resetForm(); dom.dataInput.value = await navigator.clipboard.readText(); await handleSubmit(); } catch (err) { showMessage('Auto-paste failed. Please paste manually.', true); } });
            dom.copyFilenameButton.addEventListener('click', () => copyToClipboard(dom.filenameOutput.textContent, dom.copyFilenameButton));
            dom.editFilenameButton.addEventListener('click', () => handleFilenameEdit(dom.filenameOutput.isContentEditable));
            document.addEventListener('keydown', (e) => {
                const active = document.activeElement, isEditing = active.isContentEditable || ['TEXTAREA', 'INPUT'].includes(active.tagName);
                if (e.key === 'Enter' && !isEditing && !e.shiftKey) { e.preventDefault(); handleSubmit(); }
                if (e.key === 'Backspace' && !isEditing) { e.preventDefault(); resetForm(); }
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                const handleGlobalDrag = (e) => { e.preventDefault(); e.stopPropagation(); };
                window.addEventListener(eventName, handleGlobalDrag, false);
                const handleZoneHighlight = (e) => {
                    e.preventDefault(); e.stopPropagation();
                    const isOver = eventName === 'dragenter' || eventName === 'dragover';
                    dom.dropZone.classList.toggle('bg-blue-900/60', isOver);
                    dom.dropZone.classList.toggle('border-blue-500', isOver);
                };
                dom.dropZone.addEventListener(eventName, handleZoneHighlight, false);
            });
            window.addEventListener('dragenter', () => dom.body.classList.add('dragging'));
            window.addEventListener('drop', e => {
                dom.body.classList.remove('dragging');
                if (e.dataTransfer?.files[0]) handleFileSelect(e.dataTransfer.files[0]);
            });
        }
        
        initializeApp();
    })();
    </script>
</body>
</html>

